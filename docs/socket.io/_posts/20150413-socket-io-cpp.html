

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Socket.IO C++ &mdash; WebSockets Docs v2019.0613 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Socket.IO on iOS" href="20150309-ios.html" />
    <link rel="prev" title="Socket.IO P2P" href="20150714-p2p.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> WebSockets Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">WebSockets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">api</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../awesome.html">Awesome WebSockets</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">socket.io 文档</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../get-started/index.html">Get started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docs/index.html">Docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos/index.html">Demos</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">发布历史</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="20170624-2.0.x.html">Socket.IO 2.0.1, 2.0.2 and 2.0.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="20170515-open-collective.html">Socket.IO is on Open Collective</a></li>
<li class="toctree-l3"><a class="reference internal" href="20170513-2-0-0.html">Socket.IO 2.0.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="20160127-1.4.5.html">Socket.IO 1.4.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="20160111-1.4.4.html">Socket.IO 1.4.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="20160108-1.4.x.html">Socket.IO 1.4.1, 1.4.2 and 1.4.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="20160106-1.4.0.html">Socket.IO 1.4.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="20150715-1.3.6.html">Socket.IO 1.3.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="20150714-p2p.html">Socket.IO P2P</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Socket.IO C++</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-qt-gui-application">Creating a QT GUI Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#importing-an-sioclient">Importing an SioClient</a></li>
<li class="toctree-l4"><a class="reference internal" href="#importing-boost">Importing Boost</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-the-main-window-ui">Create the Main Window UI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-slots-in-the-main-window">Add Slots in the Main Window</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connect-the-ui-event-signal-and-slots">Connect the UI Event Signal and Slots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-ui-refresh-signals-slots">Adding UI Refresh Signals/Slots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-the-socket">Setting up the Socket</a></li>
<li class="toctree-l4"><a class="reference internal" href="#managing-connection-state">Managing Connection State</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-socket-io-events">Handling Socket.IO Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wrapping-up-sending-the-message">Wrapping Up: Sending the Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="20150309-ios.html">Socket.IO on iOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="20150303-1.3.5.html">Socket.IO 1.3.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="20150204-1.3.3.html">Socket.IO 1.3.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="20150120-native-socket-io-and-android.html">Native Socket.IO and Android</a></li>
<li class="toctree-l3"><a class="reference internal" href="20140528-1.0.0.html">Introducing Socket.IO 1.0</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">WebSockets Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">socket.io 文档</a> &raquo;</li>
        
          <li><a href="index.html">发布历史</a> &raquo;</li>
        
      <li>Socket.IO C++</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/socket.io/_posts/20150413-socket-io-cpp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="socket-io-c">
<h1>Socket.IO C++<a class="headerlink" href="#socket-io-c" title="永久链接至标题">¶</a></h1>
<p>I’m really proud to announce the first release of the Socket.IO C++
Client on GitHub!</p>
<p>Based on Boost and WebSocket++, this full-featured Socket.IO 1.0 client
has the fundamental advantage of working on <strong>multiple platforms</strong>.
Check out the directory of examples. It contains examples of iOS, QT,
and CLI chat clients!</p>
<p>To learn how to use this client, I put together a QT chat example that
communicates using a Socket.IO Node.JS chat server. Keep reading for
step-by-step instructions.</p>
<p style="text-align: center"></p><div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题">¶</a></h2>
<p>If you’d like to follow along, begin by cloning the socket.io-client-cpp
repository using the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone --recurse-submodules https://github.com/socketio/socket.io-client-cpp.git
</pre></div>
</div>
<p>The app includes the following features:</p>
<ul class="simple">
<li><p>Send messages to all users joining the room.</p></li>
<li><p>Receive a notification when users join or leave the room.</p></li>
<li><p>Receive notifications when a user starts typing a message.</p></li>
</ul>
<p>Before you get started, visit the QT community to download and install
QT.</p>
</div>
<div class="section" id="creating-a-qt-gui-application">
<h2>Creating a QT GUI Application<a class="headerlink" href="#creating-a-qt-gui-application" title="永久链接至标题">¶</a></h2>
<p>Launch the QT Creator.</p>
<p>On the welcome page, select <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Project</span></code>, then create a
<code class="docutils literal notranslate"><span class="pre">QT</span> <span class="pre">Widget</span> <span class="pre">Application.</span></code> Name it <code class="docutils literal notranslate"><span class="pre">SioChatDemo.</span></code></p>
<p>The project structure should look like this:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">SioChatDemo</span>
    <span class="o">|</span><span class="nx">__</span> <span class="nx">SioChatDemo</span><span class="p">.</span><span class="nx">pro</span>
    <span class="o">|</span><span class="nx">__Headers</span>
    <span class="o">|</span>   <span class="o">|</span><span class="nx">__mainwindow</span><span class="p">.</span><span class="nx">h</span>
    <span class="o">|</span><span class="nx">__Sources</span>
    <span class="o">|</span>   <span class="o">|</span><span class="nx">__main</span><span class="p">.</span><span class="nx">cpp</span>
    <span class="o">|</span>   <span class="o">|</span><span class="nx">__mainwindow</span><span class="p">.</span><span class="nx">cpp</span>
    <span class="o">|</span><span class="nx">__Forms</span>
        <span class="o">|</span><span class="nx">__mainwindow</span><span class="p">.</span><span class="nx">ui</span>
</pre></div>
</div>
</div>
<div class="section" id="importing-an-sioclient">
<h2>Importing an SioClient<a class="headerlink" href="#importing-an-sioclient" title="永久链接至标题">¶</a></h2>
<p>Lets copy the SioClient into the QT project under the subfolder
<code class="docutils literal notranslate"><span class="pre">sioclient.</span></code></p>
<p>Edit <code class="docutils literal notranslate"><span class="pre">SioChatDemo.pro</span></code> to configure paths and compile options by
simply adding:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SOURCES</span> <span class="o">+=</span> ./sioclient/src/sio_client.cpp
           ./sioclient/src/sio_packet.cpp

<span class="nv">HEADERS</span>  <span class="o">+=</span> ./sioclient/src/sio_client.h
            ./sioclient/src/sio_message.h

<span class="nv">INCLUDEPATH</span> <span class="o">+=</span> <span class="nv">$$</span>PWD/sioclient/lib/rapidjson/include
<span class="nv">INCLUDEPATH</span> <span class="o">+=</span> <span class="nv">$$</span>PWD/sioclient/lib/websocketpp
</pre></div>
</div>
<p>Add two additional compile options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CONFIG</span><span class="o">+=</span>no_keywords
<span class="nv">CONFIG</span><span class="o">+=</span>c++11
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">no_keywords</span></code> flag prevents <code class="docutils literal notranslate"><span class="pre">qmake</span></code> from treating some function
names as <code class="docutils literal notranslate"><span class="pre">emit</span></code> as the keyword for the signal-slot mechanism.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">c++11</span></code> to ask for C++11 support.</p>
</div>
<div class="section" id="importing-boost">
<h2>Importing Boost<a class="headerlink" href="#importing-boost" title="永久链接至标题">¶</a></h2>
<p>We now have our boost <code class="docutils literal notranslate"><span class="pre">headers</span></code> and a fat boost <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">lib</span></code> named
<code class="docutils literal notranslate"><span class="pre">libboost.a</span></code>(non-win32) or <code class="docutils literal notranslate"><span class="pre">boost.lib</span></code>(win32).</p>
<p>To import them, we need to edit <code class="docutils literal notranslate"><span class="pre">SioChatDemo.pro</span></code> again by adding a
header including the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">INCLUDEPATH</span> <span class="o">+=</span> <span class="sb">`</span>our boost headers folder<span class="sb">`</span>
</pre></div>
</div>
<p>Linker options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>win32:CONFIG<span class="o">(</span>release, debug<span class="p">|</span>release<span class="o">)</span>: <span class="nv">LIBS</span> <span class="o">+=</span> -L<span class="sb">`</span>our Win32 boost static lib folder<span class="sb">`</span> -lboost
<span class="k">else</span>:win32:CONFIG<span class="o">(</span>debug, debug<span class="p">|</span>release<span class="o">)</span>: <span class="nv">LIBS</span> <span class="o">+=</span> -L<span class="sb">`</span>our Win32 boost static lib folder<span class="sb">`</span> -lboost
<span class="k">else</span>:unix: <span class="nv">LIBS</span> <span class="o">+=</span> -L<span class="sb">`</span>our osx boost static lib folder<span class="sb">`</span> -lboost
</pre></div>
</div>
</div>
<div class="section" id="create-the-main-window-ui">
<h2>Create the Main Window UI<a class="headerlink" href="#create-the-main-window-ui" title="永久链接至标题">¶</a></h2>
<p>Create a simple UI by dragging and dropping a widget from the widget box
on the left-hand side.</p>
<p style="text-align: center"></p><p>It contains the following:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">QLineEdit</span></code> at the top to input a nickname: <code class="docutils literal notranslate"><span class="pre">nickNameEdit</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">QPushButton</span></code> at the top right for login: <code class="docutils literal notranslate"><span class="pre">loginBtn</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">QListWidget</span></code> in the center for showing messages: <code class="docutils literal notranslate"><span class="pre">listView</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">QLineEdit</span></code> at the bottom for typing messages: <code class="docutils literal notranslate"><span class="pre">messageEdit</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">QPushButton</span></code> at the bottom right for sending messages:
<code class="docutils literal notranslate"><span class="pre">sendBtn</span></code></p></li>
</ul>
</div>
<div class="section" id="add-slots-in-the-main-window">
<h2>Add Slots in the Main Window<a class="headerlink" href="#add-slots-in-the-main-window" title="永久链接至标题">¶</a></h2>
<p>The following slots need to be added in the <code class="docutils literal notranslate"><span class="pre">mainwindow</span></code> class to
handle UI events:</p>
<ul class="simple">
<li><p>Click ‘Login’ button</p></li>
<li><p>Click ‘Send Message’ button</p></li>
<li><p>Text change in message editing (to show typing status)</p></li>
<li><p>Return message editing (for sending responses)</p></li>
</ul>
<p>Insert the following code into the <code class="docutils literal notranslate"><span class="pre">MainWindow</span></code> class in
<code class="docutils literal notranslate"><span class="pre">mainwindow.h</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="nl">Q_SLOTS</span><span class="p">:</span>
    <span class="kt">void</span> <span class="n">SendBtnClicked</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">TypingChanged</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">LoginClicked</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">OnMessageReturn</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="connect-the-ui-event-signal-and-slots">
<h2>Connect the UI Event Signal and Slots<a class="headerlink" href="#connect-the-ui-event-signal-and-slots" title="永久链接至标题">¶</a></h2>
<p>Open <code class="docutils literal notranslate"><span class="pre">mainwindow.ui</span></code> in the design mode. Switch to the
<code class="docutils literal notranslate"><span class="pre">signals/slots</span></code> mode using <code class="docutils literal notranslate"><span class="pre">Menu-&gt;Edit-&gt;Edit</span> <span class="pre">Signals/Slots</span></code>.</p>
<p>Click and hold the widget and drag it to the window (the cursor will
become an electrical ground symbol) to open the connection editor.</p>
<p>In the connection editor, edit the main window slots on the right side.
Add the slot function names added in <code class="docutils literal notranslate"><span class="pre">mainwindow.h</span></code> before.</p>
<p>Then we can connect the event signal to the widget with our own slots.
The result should look like this:</p>
<p style="text-align: center"></p></div>
<div class="section" id="adding-ui-refresh-signals-slots">
<h2>Adding UI Refresh Signals/Slots<a class="headerlink" href="#adding-ui-refresh-signals-slots" title="永久链接至标题">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">sio::client</span></code> callbacks are not in the UI thread. However, the UI
must be updated with those callbacks, so we need a signal for the non-UI
thread to request the <code class="docutils literal notranslate"><span class="pre">slots</span></code> functions in the UI thread. To signal
that <code class="docutils literal notranslate"><span class="pre">QListWidgetItem</span></code> has been added, insert the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// in mainwindow.h</span>
<span class="nl">Q_SIGNALS</span><span class="p">:</span>
    <span class="kt">void</span> <span class="n">RequestAddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span> <span class="o">*</span><span class="n">item</span><span class="p">);</span>
<span class="k">private</span> <span class="nl">Q_SLOTS</span><span class="p">:</span>
    <span class="kt">void</span> <span class="n">AddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span> <span class="o">*</span><span class="n">item</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//In mainwindow.cpp</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">AddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">findChild</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">QListWidget</span><span class="o">*&gt;</span><span class="p">(</span><span class="s">&quot;listView&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then connect them in the <code class="docutils literal notranslate"><span class="pre">MainWindow</span></code> constructor.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">connect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="n">SIGNAL</span><span class="p">(</span><span class="n">RequestAddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span><span class="o">*</span><span class="p">)),</span><span class="k">this</span><span class="p">,</span><span class="n">SLOT</span><span class="p">(</span><span class="n">AddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span><span class="o">*</span><span class="p">)));</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-socket">
<h2>Setting up the Socket<a class="headerlink" href="#setting-up-the-socket" title="永久链接至标题">¶</a></h2>
<p>For single-window applications, simply let <code class="docutils literal notranslate"><span class="pre">MainWindow</span></code> class hold the
<code class="docutils literal notranslate"><span class="pre">sio::client</span></code> object by declaring a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> member of the
<code class="docutils literal notranslate"><span class="pre">sio::client</span></code> and several event handling functions in
<code class="docutils literal notranslate"><span class="pre">mainwindow.h</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">OnNewMessage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnUserJoined</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnUserLeft</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnTyping</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnStopTyping</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnLogin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnConnected</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">OnClosed</span><span class="p">(</span><span class="n">client</span><span class="o">::</span><span class="n">close_reason</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">reason</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">OnFailed</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">client</span><span class="o">&gt;</span> <span class="n">_io</span><span class="p">;</span>
</pre></div>
</div>
<p>Initialize <code class="docutils literal notranslate"><span class="pre">sio::client</span></code> and setup event bindings for the default
<code class="docutils literal notranslate"><span class="pre">socket</span></code> in the <code class="docutils literal notranslate"><span class="pre">MainWindow</span></code> constructor.</p>
<p>We also need to handle connectivity and disconnect events.</p>
<p>Add the following to the <code class="docutils literal notranslate"><span class="pre">MainWindow</span></code> constructor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MainWindow</span><span class="o">::</span><span class="n">MainWindow</span><span class="p">(</span><span class="n">QWidget</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span>
    <span class="n">QMainWindow</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span>
    <span class="n">ui</span><span class="p">(</span><span class="k">new</span> <span class="n">Ui</span><span class="o">::</span><span class="n">MainWindow</span><span class="p">),</span>
    <span class="n">_io</span><span class="p">(</span><span class="k">new</span> <span class="n">client</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">ui</span><span class="o">-&gt;</span><span class="n">setupUi</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_3</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_4</span><span class="p">;</span>
    <span class="n">socket</span><span class="o">::</span><span class="n">ptr</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">_io</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">();</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;new message&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnNewMessage</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;user joined&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnUserJoined</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;user left&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnUserLeft</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;typing&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnTyping</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;stop typing&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnStopTyping</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;login&quot;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnLogin</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">,</span><span class="n">_3</span><span class="p">,</span><span class="n">_4</span><span class="p">));</span>
    <span class="c1">//default socket opened, also we have &quot;set_open_listener&quot; for monitoring physical connection opened.</span>
    <span class="n">_io</span><span class="o">-&gt;</span><span class="n">set_socket_open_listener</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnConnected</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span>
    <span class="c1">//physical connection closed or drop.</span>
    <span class="n">_io</span><span class="o">-&gt;</span><span class="n">set_close_listener</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnClosed</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">));</span>
    <span class="c1">//physical connection fail to establish.</span>
    <span class="n">_io</span><span class="o">-&gt;</span><span class="n">set_fail_listener</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MainWindow</span><span class="o">::</span><span class="n">OnFailed</span><span class="p">,</span><span class="k">this</span><span class="p">));</span>
    <span class="n">connect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="n">SIGNAL</span><span class="p">(</span><span class="n">RequestAddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span><span class="o">*</span><span class="p">)),</span><span class="k">this</span><span class="p">,</span><span class="n">SLOT</span><span class="p">(</span><span class="n">AddListItem</span><span class="p">(</span><span class="n">QListWidgetItem</span><span class="o">*</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="managing-connection-state">
<h2>Managing Connection State<a class="headerlink" href="#managing-connection-state" title="永久链接至标题">¶</a></h2>
<p>We have several connection listeners for connection events.</p>
<p>First, we want to send a login message when were connected; we get the
default <code class="docutils literal notranslate"><span class="pre">socket</span></code> from the <code class="docutils literal notranslate"><span class="pre">client</span></code> to do that.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">OnConnected</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">QByteArray</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">m_name</span><span class="p">.</span><span class="n">toUtf8</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">nickName</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">bytes</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
    <span class="n">_io</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">emit</span><span class="p">(</span><span class="s">&quot;add user&quot;</span><span class="p">,</span> <span class="n">nickName</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the connection closes or fails, we need to restore the UI before we
connect.</p>
<p>````cpp void MainWindow::OnClosed(client::close_reason const&amp; reason) {
//restore UI to pre-login state }</p>
<p>void MainWindow::OnFailed() { //restore UI to pre-login state }</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">If</span> <span class="nx">we</span> <span class="nx">exit</span> <span class="nx">the</span> <span class="sb">`MainWindow`</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">need</span> <span class="nx">to</span> <span class="nx">clear</span> <span class="nx">the</span> <span class="nx">event</span> <span class="nx">bindings</span> <span class="nx">and</span> <span class="nx">listeners</span><span class="p">.</span>

<span class="nx">The</span> <span class="sb">`sio::client`</span> <span class="nx">object</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">destroyed</span> <span class="nx">using</span> <span class="sb">`unique_ptr`</span><span class="p">.</span>

<span class="sb">```cpp</span>
<span class="sb">MainWindow::~MainWindow()</span>
<span class="sb">{</span>
<span class="sb">    _io-&gt;socket()-&gt;off_all();</span>
<span class="sb">    _io-&gt;socket()-&gt;off_error();</span>
<span class="sb">    delete ui;</span>
<span class="sb">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handling-socket-io-events">
<h2>Handling Socket.IO Events<a class="headerlink" href="#handling-socket-io-events" title="永久链接至标题">¶</a></h2>
<p>We’ll need to handle socket.io events in our functions they are bound
to.</p>
<p>For example, we need to show received messages in the list view.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">OnNewMessage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span><span class="kt">bool</span> <span class="n">hasAck</span><span class="p">,</span><span class="n">message</span><span class="o">::</span><span class="n">ptr</span> <span class="o">&amp;</span><span class="n">ack_resp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">get_flag</span><span class="p">()</span> <span class="o">==</span> <span class="n">message</span><span class="o">::</span><span class="n">flag_object</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">get_map</span><span class="p">()[</span><span class="s">&quot;message&quot;</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_string</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">get_map</span><span class="p">()[</span><span class="s">&quot;username&quot;</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_string</span><span class="p">();</span>
        <span class="n">QString</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromUtf8</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">name</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
        <span class="n">label</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
        <span class="n">label</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">QString</span><span class="o">::</span><span class="n">fromUtf8</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">msg</span><span class="p">.</span><span class="n">length</span><span class="p">()));</span>
        <span class="n">QListWidgetItem</span> <span class="o">*</span><span class="n">item</span><span class="o">=</span> <span class="k">new</span> <span class="n">QListWidgetItem</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
        <span class="c1">//emit RequestAddListItem signal</span>
        <span class="c1">//so that &#39;AddListItem&#39; will be executed in UI thread.</span>
        <span class="n">Q_EMIT</span> <span class="nf">RequestAddListItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="wrapping-up-sending-the-message">
<h2>Wrapping Up: Sending the Message<a class="headerlink" href="#wrapping-up-sending-the-message" title="永久链接至标题">¶</a></h2>
<p>When <code class="docutils literal notranslate"><span class="pre">sendBtn</span></code> is clicked, we need to send the text in <code class="docutils literal notranslate"><span class="pre">messageEdit</span></code>
to the chatroom.</p>
<p>Add the following code to <code class="docutils literal notranslate"><span class="pre">SendBtnClicked()</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">SendBtnClicked</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">QLineEdit</span><span class="o">*</span> <span class="n">messageEdit</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findChild</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">QLineEdit</span><span class="o">*&gt;</span><span class="p">(</span><span class="s">&quot;messageEdit&quot;</span><span class="p">);</span>
    <span class="n">QString</span> <span class="n">text</span> <span class="o">=</span> <span class="n">messageEdit</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">QByteArray</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">toUtf8</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">bytes</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
        <span class="n">_io</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">emit</span><span class="p">(</span><span class="s">&quot;new message&quot;</span><span class="p">,</span><span class="n">msg</span><span class="p">);</span><span class="c1">//emit new message</span>
        <span class="n">text</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;:You&quot;</span><span class="p">);</span>
        <span class="n">QListWidgetItem</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QListWidgetItem</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
        <span class="n">item</span><span class="o">-&gt;</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">AlignRight</span><span class="p">);</span>
        <span class="n">Q_EMIT</span> <span class="nf">RequestAddListItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="n">messageEdit</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="永久链接至标题">¶</a></h2>
<p>You can run the demo project to get a closer look. Before you run it,
please follow the instructions to make the Socket.io client library.</p>
<p>Don’t forget to star the project on GitHub to get updates!</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="20150309-ios.html" class="btn btn-neutral float-right" title="Socket.IO on iOS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="20150714-p2p.html" class="btn btn-neutral float-left" title="Socket.IO P2P" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>